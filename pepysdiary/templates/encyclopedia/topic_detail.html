{% extends "base.html" %}
{% load url from future %}

{% block encyclopedia_nav_active %}active{% endblock %}

{% block title %}{{ topic.title }}{% endblock %}}
{% block header_title %}{{ topic.title }}{% endblock %}}

{% block breadcrumbs %}
	{% for category in topic.categories.all %}
		{% include 'inc/category_breadcrumb.html' with link_final_item="true" %}
	{% endfor %}
{% endblock breadcrumbs %}


{% block extra_css %}
	{% if topic.has_location %}
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
		<!--[if lte IE 8]>
		    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.ie.css" />
		<![endif]-->
	{% endif %}
{% endblock %}

{% block extra_javascript_includes %}
	{% if topic.has_location %}
		<script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
	{% endif %}

	{% if diary_references %}
		<!-- For the References Chart -->
		<script src="http://d3js.org/d3.v3.min.js"></script>
	{% endif %}
{% endblock %}

{% block extra_jquery %}
	{% if topic.has_location %}
		pepys.topic.draw_map({
			{% if topic.has_polygon %}
				polygon: "{{ topic.shape|escapejs }}",
			{% endif %}
			{% if topic.has_path %}
				path: "{{ topic.shape|escapejs }}",
			{% endif %}
			latitude: {{ topic.latitude }},
			longitude: {{ topic.longitude }},
			zoom: {{ topic.zoom }},
			title: "{{ topic.title|escapejs }}",
			tooltip_text: "{{ topic.tooltip_text|escapejs }}"
		});
	{% endif %}

	{% if diary_references %}
		// For the References Chart.
		// We'll map {'Feb 1663': 7, ...}
		// ie, the number of references in a particular month.
	  	var references = {}; 
	  	{% for y, months in diary_references %}
	  		{% for m, refs in months %}
		  		references['{{ m }} {{ y }}'] = {{ refs|length }};
			{% endfor %}
		{% endfor %}

		pepys.topic.draw_references_chart(references);
	{% endif %}
{% endblock %}


{% block main_content %}

	{% load text_formatting_filters %}

	<div class="tabbable">
		<ul class="nav nav-tabs">
			{% if topic.latitude %}
				<li id="tab-map" class="active"><a href="#map" data-toggle="tab">Map</a></li>
			{% endif %}
			{% if topic.summary_html %}
				<li id="tab-summary" class="{% if not topic.latitude and topic.summary_html %}active{% endif %}{% if not topic.summary_html %}disabled{% endif %}"><a href="#summary" data-toggle="tab">Summary</a></li>
			{% endif %}
			{% if topic.wikipedia_fragment %}
				<li id="tab-wikipedia" class="{% if not topic.latitude and not topic.summary_html and topic.wikipedia_fragment %}active{% endif %}{% if not topic.wikipedia_fragment %}disabled{% endif %}"><a href="#wikipedia" data-toggle="tab">Wikipedia</a></li>
			{% endif %}
			{% if topic.wheatley_html %}
				<li id="tab-wheatley" class="{% if not topic.latitude and not topic.summary_html and not topic.wikipedia_fragment and topic.wheatley_html %}active{% endif %}{% if not topic.wheatley_html %}disabled{% endif %}"><a href="#wheatley" data-toggle="tab">1893 text</a></li>
			{% endif %}
			<li id="tab-discussion" class="{% if not topic.latitude and not topic.summary_html and not topic.wikipedia_fragment and not topic.wheatley_html %}active{% endif %}"><a href="#discussion" data-toggle="tab">Annotations ({{ topic.comment_count }})</a></li>
			{% if diary_references %}
				<li id="tab-references"><a href="#references" data-toggle="tab">References ({{ topic.diary_references.count }})</a></li>
			{% endif %}
		</ul>

		<div class="tab-content">
			{% if perms.topic.can_edit %}
				<p class="admin-links"><small><a class="admin" href="{% url 'admin:encyclopedia_topic_change' topic.id %}"><i class="icon-edit icon-link"></i> Edit</a></small></p>
        	{% endif %}

			{% if topic.has_location %}
				<div class="tab-pane active" id="map">
					<h2 class="hide">Map</h2>
					<div id="map-frame">
					</div> <!-- #map-frame -->

					<div class="muted">
						<p>The overlays that highlight 17th century London features are approximate and derived from:</p>
						<ul>
							<li>City of London wall and Great Fire damage – <a href="http://commons.wikimedia.org/wiki/File:Map.London.gutted.1666.jpg">Hollar's 1666 map after the Fire</a></li>
							<li>Built-up London – <a href="http://link.library.utoronto.ca/hollar/digobject.cfm?Idno=Hollar_k_2465&size=zoom&query=london&type=search">Hollar's 1666 map before the Fire</a></li>
						</ul>
					</div>
				</div>
			{% endif %}

			{% if topic.summary_html %}
				<article class="tab-pane{% if not topic.latitude %} active{% endif %}" id="summary">
					<h2>Summary</h2>
					{{ topic.summary_html|smartypants|safe }}
				</article>
			{% endif %}

			{% if topic.wikipedia_fragment %}
				<article class="tab-pane{% if not topic.latitude and not topic.summary_html %} active{% endif %}" id="wikipedia">
					<h2>Wikipedia</h2>
					<p>Wikipedia content is not yet automatically copied to this page.</p>
					<p>For now, you can directly <a href="http://en.wikipedia.org/wiki/{{ topic.wikipedia_fragment }}">visit this topic on Wikipedia</a>.</p>
				</article>
			{% endif %}

			{% if topic.wheatley_html %}
				<article class="tab-pane{% if not topic.latitude and not topic.summary_html and not topic.wikipedia_fragment %} active{% endif %}" id="wheatley">
					<h2>1893 text</h2>
					<div class="well well-manuscript">
						{{ topic.wheatley_html|smartypants|safe }}
					</div>
				</article>
			{% endif %}

			<div class="tab-pane{% if not topic.latitude and not topic.summary_html and not topic.wikipedia_fragment and not topic.wheatley_html %} active{% endif %}" id="discussion">
				{% include 'inc/comments.html' with object=topic %}
			</div>

			{% if diary_references %}
				<div class="tab-pane" id="references">
					<h2>References</h2>

					<div id="chart-references"></div>

					<ul class="references references-diary">
						{% for y, months in diary_references %}
							<li>{{ y }}
								<ul class="references-year">
									{% for m, refs in months %}
										<li><span>{{ m }}</span>
											<ul class="references-month">
												{% for entry in refs %}
													<li><a href="{{ entry.get_absolute_url }}">{{ entry.day_e }}</a></li>
												{% endfor %}
											</ul>
										</li>
									{% endfor %}
								</ul>
							</li>
						{% endfor %}
					</ul>
				</div>
			{% endif %}
		</div> <!-- .tab-content -->
	</div> <!-- .tabbable -->

{% endblock main_content %}


{% block sidebar_content %}

	{% if topic.thumbnail %}
		<div class="sidebar-block">
			<p><img src="{{ topic.thumbnail.url }}" class="thumbnail" width="100" height="120" alt="Thumbnail image" /></p>
		</div>
	{% endif %}

	{% if topic.on_pepys_family_tree or topic.title == 'Pepys family tree' %}
		<div class="sidebar-block">
			<p><a href="{% url 'encyclopedia_familytree' %}"><img class="thumbnail" src="{{ STATIC_PREFIX }}img/sidebar_family_tree.png" width="250" height="134" alt="Family tree thumbnail" />
			{% if topic.on_pepys_family_tree %}
				See this person on the Pepys family tree
			{% else %}
				See the Pepys family tree
			{% endif %}
			</a></p>
		</div>
	{% endif %}

	{% load widget_tags %}
	{% rss_feeds 'topics' %}

{% endblock sidebar_content %}
