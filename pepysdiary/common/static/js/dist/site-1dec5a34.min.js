function isNumber(t){return!isNaN(parseFloat(t))&&isFinite(t)}jQuery.fn.exists=function(){return jQuery(this).length>0},window.pepys={},window.pepys.controller={config:{mapbox_map_id:"",static_prefix:""},init:function(t){"config"in t&&$.extend(this.config,t.config),"tooltips"in t&&pepys.tooltips.init(t.tooltips),pepys.comments.init(),pepys.topic.init(),$("time.timeago").timeago()}},window.pepys.utilities={diary_years_months:function(){return{1660:{Jan:31,Feb:29,Mar:31,Apr:30,May:31,Jun:30,Jul:31,Aug:31,Sep:30,Oct:31,Nov:30,Dec:31},1661:{Jan:31,Feb:28,Mar:31,Apr:30,May:31,Jun:30,Jul:31,Aug:31,Sep:30,Oct:31,Nov:30,Dec:31},1662:{Jan:31,Feb:28,Mar:31,Apr:30,May:31,Jun:30,Jul:31,Aug:31,Sep:30,Oct:31,Nov:30,Dec:31},1663:{Jan:31,Feb:28,Mar:31,Apr:30,May:31,Jun:30,Jul:31,Aug:31,Sep:30,Oct:31,Nov:30,Dec:31},1664:{Jan:31,Feb:29,Mar:31,Apr:30,May:31,Jun:30,Jul:31,Aug:31,Sep:30,Oct:31,Nov:30,Dec:31},1665:{Jan:31,Feb:28,Mar:31,Apr:30,May:31,Jun:30,Jul:31,Aug:31,Sep:30,Oct:31,Nov:30,Dec:31},1666:{Jan:31,Feb:28,Mar:31,Apr:30,May:31,Jun:30,Jul:31,Aug:31,Sep:30,Oct:31,Nov:30,Dec:31},1667:{Jan:31,Feb:28,Mar:31,Apr:30,May:31,Jun:30,Jul:31,Aug:31,Sep:30,Oct:31,Nov:30,Dec:31},1668:{Jan:31,Feb:28,Mar:31,Apr:30,May:31,Jun:30,Jul:31,Aug:31,Sep:30,Oct:31,Nov:30,Dec:31},1669:{Jan:31,Feb:29,Mar:31,Apr:30,May:31}}}},window.pepys.tooltips={tooltips:{},encyclopedia_link_re:null,init:function(t){this.tooltips=t,this.encyclopedia_link_re=/\/(\d+)\/$/,this.prepare_tooltips()},prepare_tooltips:function(){var t=this;$("article.entry, article.letter").find("a").each(function(){if(id=t.id_from_encyclopedia_url($(this).attr("href")),id in t.tooltips){var i={title:t.tooltips[id].title,content:t.tooltip_content(t.tooltips[id].text,t.tooltips[id].thumbnail_url),trigger:"hover click",placement:"auto left",html:!0};t.tooltips[id].thumbnail_url&&(i.template='<div class="popover popover-hasthumbnail" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'),$(this).popover(i)}})},id_from_encyclopedia_url:function(t){return t?-1==t.indexOf("/encyclopedia/")?"":this.encyclopedia_link_re.exec(t)[1]:""},tooltip_content:function(t,i){return i?'<img src="'+i+'" class="thumbnail" width="100" height="120" alt="Thumbnail" />'+t:t}},window.pepys.comments={prev_visit_end:null,init:function(){this.init_hash_link(),this.init_newables()},init_hash_link:function(){var t=window.location.hash.substring(1);t&&t.match(/^c\d+$/)&&$("#"+t).exists()&&$("#"+t).addClass("focused")},init_newables:function(){this.get_cookies(),this.set_markers()},get_cookies:function(){cookie_value=readCookie("prev_visit_end"),isNumber(cookie_value)&&(this.prev_visit_end=parseInt(cookie_value,10))},set_markers:function(){var t=this;$(".newable").each(function(){(null===t.prev_visit_end||parseInt($(this).data("time"),10)>t.prev_visit_end)&&$("i.newflag",$(this)).addClass("is-new").html("<span>New</span>").attr("title","New")})}},window.pepys.category={category_id:null,valid_map_category_ids:[],topics:[],start_coords:{britain:{latitude:52.5,longitude:-1.9,zoom:6},london:{latitude:51.508,longitude:-.1091,zoom:14},environs:{latitude:51.508,longitude:-.1791,zoom:11},waterways:{latitude:52,longitude:-1.3,zoom:7},whitehall:{latitude:51.5035,longitude:-.1257,zoom:17},world:{latitude:24.0389,longitude:25.045,zoom:2}},categories_start_coords:{30:"britain",45:"world",180:"whitehall",209:"waterways",214:"environs"},init_map:function(t){this.resize_map();var i=this;$(window).resize(function(){i.resize_map()}),this.valid_map_category_ids=t.valid_map_category_ids,this.topics=t.topics,this.is_valid_map_category_id(t.category_id)&&(this.category_id=t.category_id,this.draw_category_map(this.category_id)),this.init_form()},init_form:function(){$("#category-form button").hide(),$("#category-form select").change(function(){$("#category-form").submit()})},draw_category_map:function(t){if(this.is_valid_map_category_id(t)){this.category_id=t;var i=this.start_coords.london;this.category_id.toString()in this.categories_start_coords&&(i=this.start_coords[this.categories_start_coords[this.category_id.toString()]]),pepys.maps.init(i),$.each(this.topics,function(t,i){pepys.maps.add_place(i,{link_to_topic:!0})})}},resize_map:function(){var t=$("#content"),i=$("#map-frame"),e=$(window).height()-t.offset().top-(t.outerHeight(!0)-t.height());600>e&&(e=600);var o=e-(i.offset().top-t.offset().top)-$(".mapkey").height();t.height(e+"px"),i.height(o+"px")},is_valid_map_category_id:function(t){return-1==$.inArray(t,this.valid_map_category_ids)?!1:!0}},window.pepys.topic={valid_tabs:["map","summary","wikipedia","wheatley","discussion","references"],init:function(){this.init_tabs()},init_tabs:function(){var t=window.location.hash.substring(1);t&&(t.match(/^c\d+$/)&&$("#"+t).exists()?($("#tab-discussion a").tab("show"),$("html, body").animate({scrollTop:$("#"+t).offset().top},500)):$.inArray(t,this.valid_tabs)>=0?$("#tab-"+t+" a").tab("show"):$("#row-wikipedia").exists()&&$("#wikipedia").exists()&&$("#tab-wikipedia a").tab("show")),$(".nav-tabs a").on("shown",function(t){var i=t.target.hash.substring(1);$(i).attr("id",i+"temp"),window.location.hash="#"+i,$(i+"temp").attr("id",i)})},draw_map:function(t){pepys.maps.init({latitude:t.latitude,longitude:t.longitude,zoom:t.zoom}),pepys.maps.add_place(t,{show_popup:!0})},draw_references_chart:function(t){var i=[];$.each(pepys.utilities.diary_years_months(),function(e,o){$.each(o,function(o,a){var n=o+" "+e,r=0,s=0;n in t&&(r=t[n],s=Math.round(r/a*100)),i.push({name:n,num_refs:r,percent_refs:s})})});var e=$(".tab-content").width(),o=Math.round(e/3.8),a={top:0,right:0,bottom:Math.round(o/10),left:0},n=e-a.left-a.right,r=o-a.top-a.bottom,s=Math.round(r/13),l=d3.select("#chart-references").append("svg").attr("class","chart").attr("width",e).attr("height",o).append("g").attr("transform","translate("+a.left+","+a.top+")"),p=d3.scale.ordinal().domain(d3.range(i.length)).rangeBands([0,n],0),c=d3.scale.linear().domain([0,100]).range([r,0]),d=Math.round(r/20),u=d3.svg.axis().scale(p).orient("bottom").tickValues([0,12,24,36,48,60,72,84,96,108]).tickSize(d,0,0).tickFormat(function(t){return i[t].name.substring(4,8)});l.append("g").attr("class","axis axis-x").attr("transform","translate(-"+p.rangeBand()/2+","+r+")").call(u),l.selectAll("text").attr("dx",function(t,i){var e=6*p.rangeBand();return i>=9&&(e=2.5*p.rangeBand()),e}).attr("dy",s/3).attr("font-size",s+"px");var h=d3.svg.axis().scale(c).orient("left").tickValues([25,50,75,100]).tickSize(-n,0,0).tickFormat("");l.append("g").attr("class","axis axis-y").call(h);var _=d3.select("body").append("div").attr("class","chart-tooltip").style("font-size",s+"px").style("padding-left",Math.round(s/2)+"px").style("padding-right",Math.round(s/2)+"px");l.selectAll(".bar").data(i).enter().append("rect").attr("class","bar").attr("x",function(t,i){return p(i)}).attr("y",function(t){return c(t.percent_refs)}).attr("width",p.rangeBand()).attr("height",function(t){return r-c(t.percent_refs)}).on("mouseover",function(t){_.html("<strong>"+t.num_refs+"</strong> ("+t.name+")"),d3.select(this).classed("highlight",!0),_.style("visibility","visible")}).on("mousemove",function(){_.style("top",event.pageY-10+"px").style("left",event.pageX+10+"px")}).on("mouseout",function(){d3.select(this).classed("highlight",!1),_.style("visibility","hidden")})}},window.pepys.maps={map:null,init:function(t){if(this.map=L.map("map-frame").setView([t.latitude,t.longitude],t.zoom),L.mapbox.accessToken=pepys.controller.config.mapbox_access_token,L.mapbox.tileLayer(pepys.controller.config.mapbox_map_id).addTo(this.map),this.map.scrollWheelZoom.disable(),this.init_overlays(),$("#tab-map").exists()){var i=this;$('a[data-toggle="tab"]').on("shown",function(t){return"#map"==$(t.target).attr("href")&&i.map.invalidateSize(!1),!0})}},init_overlays:function(){var t=L.layerGroup([L.polyline([[51.511046,-.104113],[51.513864,-.104027],[51.513824,-.102482],[51.516494,-.101473],[51.516641,-.095927],[51.517823,-.095347],[51.51781,-.095192],[51.518608,-.094644],[51.517643,-.090101],[51.516862,-.085562],[51.516214,-.081636],[51.515112,-.079147],[51.514024,-.077151],[51.51365,-.076593],[51.509424,-.075821]],{stroke:!0,color:"#333333",opacity:.8})]),i=L.layerGroup([L.polygon([[51.494931,-.12454],[51.495172,-.132179],[51.495813,-.13308],[51.49795,-.13381],[51.498912,-.137758],[51.49803,-.139647],[51.499473,-.14235],[51.500542,-.139904],[51.501984,-.140891],[51.50324,-.13763],[51.504869,-.139604],[51.507941,-.131879],[51.50949,-.133424],[51.509864,-.133038],[51.510746,-.13381],[51.512722,-.130806],[51.516488,-.133166],[51.516675,-.130849],[51.517236,-.125828],[51.519505,-.121279],[51.521588,-.114112],[51.522229,-.111065],[51.52311,-.110335],[51.523377,-.107288],[51.523217,-.10673],[51.523751,-.106645],[51.524392,-.103126],[51.524232,-.102696],[51.526795,-.091453],[51.52303,-.090208],[51.523324,-.087161],[51.523591,-.081453],[51.524045,-.079265],[51.529038,-.078492],[51.528931,-.077419],[51.525353,-.076432],[51.523805,-.076132],[51.520734,-.073729],[51.517049,-.071154],[51.523217,-.044374],[51.521722,-.043087],[51.515313,-.069523],[51.510772,-.066776],[51.512375,-.053043],[51.510826,-.051842],[51.512642,-.037766],[51.50949,-.028667],[51.508101,-.027294],[51.506499,-.028667],[51.508796,-.034676],[51.509544,-.038023],[51.509651,-.04283],[51.509223,-.046091],[51.508101,-.049009],[51.506819,-.051327],[51.506125,-.052271],[51.50324,-.048065],[51.501477,-.051584],[51.499981,-.056734],[51.499286,-.062828],[51.498565,-.067849],[51.499526,-.071239],[51.497469,-.078664],[51.497736,-.081968],[51.499179,-.081882],[51.501156,-.082655],[51.502465,-.083385],[51.503881,-.084071],[51.502118,-.085144],[51.502679,-.091066],[51.50121,-.092268],[51.494611,-.083942],[51.493756,-.085444],[51.499126,-.09407],[51.498404,-.095787],[51.49966,-.097718],[51.502759,-.093598],[51.503934,-.095959],[51.50551,-.096259],[51.507006,-.095873],[51.507113,-.099478],[51.505163,-.101109],[51.502225,-.100508],[51.500568,-.101066],[51.50121,-.102096],[51.503667,-.102053],[51.505297,-.102267],[51.507861,-.103855],[51.508021,-.106859],[51.507621,-.11085],[51.507006,-.113597],[51.505323,-.112438],[51.504068,-.110722],[51.502305,-.108962],[51.501156,-.107889],[51.500916,-.109563],[51.503534,-.111752],[51.504869,-.113811],[51.506632,-.114799],[51.505965,-.116472],[51.504282,-.117803],[51.502625,-.118446],[51.501584,-.115786],[51.500889,-.114884],[51.499767,-.112782],[51.499339,-.113597],[51.499927,-.115614],[51.49974,-.116773],[51.499259,-.118232],[51.499794,-.118361],[51.500488,-.115571],[51.502011,-.118833],[51.499607,-.119562],[51.496641,-.120292],[51.495332,-.120034],[51.494664,-.117202],[51.491725,-.120292],[51.489053,-.121837],[51.486514,-.12351],[51.487102,-.125527],[51.490148,-.123124],[51.492633,-.121751],[51.494664,-.12115],[51.494931,-.12454]],{stroke:!1,fill:!0,fillColor:"#666666",fillOpacity:.4})]),e=L.layerGroup([L.polygon([[51.514204,-.109756],[51.514885,-.109928],[51.515353,-.109756],[51.515807,-.109456],[51.515753,-.108511],[51.516154,-.108318],[51.516114,-.107481],[51.516394,-.10731],[51.517022,-.106516],[51.516595,-.106452],[51.516955,-.105164],[51.516955,-.104885],[51.517329,-.104842],[51.517556,-.104477],[51.51781,-.103619],[51.51773,-.102847],[51.517369,-.102503],[51.517189,-.102476],[51.517085,-.101339],[51.516822,-.100003],[51.516812,-.098716],[51.516621,-.095932],[51.517803,-.095283],[51.51781,-.095192],[51.518608,-.094644],[51.517636,-.09023],[51.517222,-.089757],[51.517102,-.089382],[51.516862,-.088341],[51.516528,-.088041],[51.516007,-.088148],[51.515927,-.087891],[51.51568,-.085959],[51.515613,-.085745],[51.515486,-.085831],[51.515313,-.085369],[51.515046,-.084983],[51.514438,-.084243],[51.513477,-.084254],[51.513437,-.084007],[51.513016,-.084189],[51.512889,-.083545],[51.513096,-.083385],[51.512989,-.082451],[51.512789,-.082515],[51.512729,-.082194],[51.512602,-.082194],[51.512261,-.081207],[51.512054,-.080616],[51.511494,-.08037],[51.510959,-.080509],[51.510011,-.080745],[51.50953,-.079629],[51.50927,-.079823],[51.509043,-.079147],[51.508863,-.078771],[51.508302,-.079179],[51.507841,-.079361],[51.508328,-.081389],[51.508542,-.083621],[51.508909,-.087011],[51.509023,-.087837],[51.508983,-.090272],[51.509197,-.09201],[51.509677,-.093534],[51.510265,-.095787],[51.510692,-.098534],[51.510826,-.100272],[51.510853,-.103126],[51.510866,-.106409],[51.510893,-.109477],[51.513911,-.109949],[51.513964,-.109627],[51.514204,-.109756]],{stroke:!1,fill:!0,fillColor:"#cc6666",fillOpacity:.3})]);L.control.layers({},{"City of London wall":t,"Built-up London (rough)":i,"Great Fire damage":e}).addTo(this.map)},add_place:function(t,i){i||(i={});var e,o=new L.Icon.Default,a=L.Icon.Default.extend({options:{iconUrl:pepys.controller.config.static_prefix+"img/marker-icon-b.png",iconRetinaUrl:pepys.controller.config.static_prefix+"img/marker-icon-b@2x.png"}}),n=new a;if("polygon"in t)e=L.polygon(this.string_to_coords(t.polygon));else if("path"in t)e=L.polyline(this.string_to_coords(t.path));else{var r={icon:o};"pepys_home"in t&&t.pepys_home===!0&&(r.icon=n),e=L.marker([t.latitude,t.longitude],r)}e.addTo(this.map);var s="<strong>"+t.title+"</strong>";"tooltip_text"in t&&""!==t.tooltip_text&&(s+="<br />"+t.tooltip_text),"link_to_topic"in i&&i.link_to_topic===!0&&(s+='<br /><a href="'+t.url+'" title="See more about this topic">In the Encyclopedia</a>'),e.bindPopup(s,{minWidth:150}),"show_popup"in i&&i.show_popup===!0&&e.openPopup()},string_to_coords:function(t){var i=[];return $.each(t.split(";"),function(t,e){ll=e.split(","),i.push([parseFloat(ll[0]),parseFloat(ll[1])])}),i}},function(){function t(t,e,o,a){if(i)return i[t];for(e=document.cookie.split("; "),i={},a=e.length-1;a>=0;a--)o=e[a].split("="),i[o[0]]=o[1];return i[t]}var i;window.readCookie=t}();